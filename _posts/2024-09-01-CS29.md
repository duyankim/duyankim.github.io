---
layout: post
author: "Yan"
catalog: true
subtitle: "ì‹œìŠ¤í…œì˜ ì•ˆì •ì„±ê³¼ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ê¸°"
header-img: "img/header/none2.jpg"
title: "API Rate Limiting"
date: 2024-09-01 23:15:08 +0000
categories:
  - CS
tags:
  - Message
comments: true
---

# API Rate Limitingë€?
API Rate Limitingì€ APIì— ëŒ€í•œ ìš”ì²­ ìˆ˜ë¥¼ ì¼ì • ì‹œê°„ ë™ì•ˆ ì œí•œí•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤. ì£¼ë¡œ ì„œë¹„ìŠ¤ì˜ ì•ˆì •ì„±ì„ ìœ ì§€í•˜ê³ , íŠ¹ì • APIì— ëŒ€í•œ ê³¼ë„í•œ ìš”ì²­ìœ¼ë¡œ ì¸í•´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • APIê°€ ì´ˆë‹¹ 100ê°œì˜ ìš”ì²­ë§Œ í—ˆìš©í•œë‹¤ê³  ì„¤ì •í•˜ë©´, ê·¸ í•œë„ë¥¼ ì´ˆê³¼í•˜ëŠ” ìš”ì²­ì€ ì°¨ë‹¨ë˜ê±°ë‚˜ ì§€ì—° ì²˜ë¦¬ëœë‹¤.  

ì´ë¥¼ **Throttling**ì´ë¼ê³  í•œë‹¤. ì •í•´ì§„ ì‹œê°„ ë™ì•ˆ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” operationì˜ ìˆ˜ë¥¼ ì •í•˜ëŠ” ê²ƒì´ë‹¤.  

> ì²˜ë¦¬ìœ¨ ì œí•œ ì¥ì¹˜ëŠ” ì–´ë””ì— ë‘ëŠ” ê²ƒì´ ì¢‹ì„ê¹Œ?
- í´ë¼ì´ì–¸íŠ¸ì— ë‘”ë‹¤ë©´? í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì€ ì‰½ê²Œ ìœ„ë³€ì¡°ê°€ ê°€ëŠ¥í•´ì„œ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ìœ¨ ì œí•œì„ ê±¸ ìˆ˜ê°€ ì—†ë‹¤.
- ì„œë²„ì¸¡ì— ë‘ëŠ” ë°©ë²•ë„ ìˆë‹¤.
- ì²˜ë¦¬ìœ¨ ì œí•œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì„œ, í•´ë‹¹ ë¯¸ë“¤ì›¨ì–´ê°€ APIì„œë²„ë¡œ ê°€ëŠ” ìš”ì²­ì„ í†µì œí•˜ë„ë¡ í•  ìˆ˜ë„ ìˆë‹¤.
  - ì´ ê²½ìš°, ì²˜ë¦¬ìœ¨ ì œí•œ ê°¯ìˆ˜ë³´ë‹¤ ë” ë§ì€ ìš”ì²­ì´ ë“¤ì–´ì™“ì„ ê²½ìš°, ì²˜ë¦¬ìœ¨ ì œí•œ ë¯¸ë“¤ì›¨ì–´ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œ HTTP ìƒíƒœì½”ë“œ 429(Too Many Requests)ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.
- ì²˜ë¦¬ìœ¨ ì œí•œ ì¥ì¹˜ëŠ” ë³´í†µ API ê²Œì´íŠ¸ì›¨ì´ë¼ ë¶ˆë¦¬ëŠ” ì»´í¬ë„ŒíŠ¸ì— êµ¬í˜„ëœë‹¤. 
  - API gatewayëŠ” ì•„ë˜ì˜ ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆë‹¤:
    - ì²˜ë¦¬ìœ¨ ì œí•œ
    - SSL ì¢…ë‹¨
    - ì‚¬ìš©ì ì¸ì¦
    - IP í—ˆìš© ëª©ë¡ ê´€ë¦¬ ë“± ì§€ì› 
  - API ê²Œì´íŠ¸ì›¨ì´ ê³„ì¸µì—ì„œì˜ ì†ë„ ì œí•œì€ API ê²Œì´íŠ¸ì›¨ì´ ì¸í”„ë¼ ë‚´ì—ì„œ ì†ë„ ì œí•œ ê·œì¹™ì„ êµ¬ì„±í•˜ëŠ” ê²ƒì„ í¬í•¨í•œë‹¤. ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬ë˜ê¸° ì „ì— API ê²Œì´íŠ¸ì›¨ì´ì—ì„œ ìˆ˜ì‹ í•œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ì ìš©ëœë‹¤. ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•´ ë…¸ì¶œë˜ëŠ” ëª¨ë“  APIì™€ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì†ë„ ì œí•œ ì •ì±…ì— ëŒ€í•œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì œì–´ë¥¼ ì œê³µí•œë‹¤. ì—¬ëŸ¬ APIì— ëŒ€í•œ ê¸€ë¡œë²Œ ì†ë„ ì œí•œì„ ì ìš©í•˜ê³ , ê³µê°œ APIì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œì–´í•˜ê³ , ê³¼ë„í•œ íŠ¸ë˜í”½ìœ¼ë¡œë¶€í„° ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ ë³´í˜¸í•˜ëŠ” ë° ì í•©í•˜ë‹¤.

## ì™œ Rate Limitì´ í•„ìš”í•œê°€?
- ê³¼ë„í•œ íŠ¸ë˜í”½ìœ¼ë¡œë¶€í„° ì„œë¹„ìŠ¤ë¥¼ ë³´í˜¸
- Resource ì‚¬ìš©ì— ëŒ€í•œ ê³µì •ì„±ê³¼ í•©ë¦¬ì„± ìœ ë„
- íŠ¸ë˜í”½ ë¹„ìš©ì´ ì„œë¹„ìŠ¤ ì˜ˆì‚°ì„ ë„˜ëŠ” ê²ƒì„ ë°©ì§€
- DDos ê³µê²© ë°©ì§€
- ë°ì´í„° ìŠ¤í¬ë˜í•‘ ë°©ì§€
- Rateì— ëŒ€í•´ ê³¼ê¸ˆì„ ë¶€ê³¼í•˜ëŠ” Business Modelë¡œ í™œìš©

### Throttlingì˜ ì¢…ë¥˜

- Hard Throttling: throttle limitì„ ì—„ê²©í•˜ê²Œ ê´€ë¦¬ (ë¬´ì¡°ê±´ limitì— ë”± ë§ì¶¤)
- Soft Throttling: íŠ¹ì • í¼ì„¼íŠ¸ê¹Œì§€ëŠ” limitì„ ë„˜ê¸°ëŠ” ê²ƒì„ í—ˆìš© (10%ê¹Œì§€ë¼ë©´, limitì—ì„œ 10% ë” ê°€ëŠ¥)
- Elastic or Dynamic Throttling: ì„œë²„ ìì›ì˜ ì—¬ìœ ê°€ ì‡ì„ ë•ŒëŠ” limitì„ ë„˜ê¸°ë”ë¼ë„ ìš”ì²­ì„ í—ˆìš©í•¨

### êµ¬í˜„ ë°©ì‹

#### Rate Limit ì ìš©ì‹œ dropë˜ëŠ” ìš”ì²­ ê±´ì— ëŒ€í•œ ì‘ë‹µì€?

í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´, ë¯¸ë“¤ì›¨ì–´ëŠ” ì¹´ìš´í„°ê°€ ì¸ê³„ì¹˜ë¥¼ ë„˜ì–´ì„°ëŠ”ì§€ í™•ì¸í•˜ê³ (Redisë¥¼ ì´ìš©í•´) ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ë‹¤. ì´ ê³¼ì •ì—ì„œ í•œë„ê°€ ì´ˆê³¼ë˜ì–´ ë²„ë ¤ì§€ëŠ” RequestëŠ” HTTP Headerë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ overflow ë˜ì—ˆë‹¤ê³  ì „ë‹¬ëœë‹¤. 

429 HTTP Statusë¥¼ ë°˜í™˜í•  ë•Œ, Headerì— ì•„ë˜ ì •ë³´ë¥¼ ë„£ì–´ì£¼ë©´ ì¢‹ë‹¤.

- `X-RateLimit-Limit` í—ˆìš©ë˜ëŠ” ìš”ì²­ì˜ ìµœëŒ€ ê°œìˆ˜
- `X-RateLimit-Remaining` ë‚¨ì€ ìš”ì²­ ìˆ˜
- `X-RateLimit-Reset` ìš”ì²­ ìµœëŒ“ê°’ì´ ì¬ì„¤ì •ë  ë•Œê¹Œì§€ì˜ ì‹œê°„

#### ìš”ì²­ ìˆ˜ëŠ” ì–´ë–»ê²Œ ì €ì¥í•  ê²ƒì¸ê°€? ì¹´ìš´í„°ëŠ” ì–´ë””ì— ìˆì–´ì•¼ í• ê¹Œ?

Rate Limit APIëŠ” ê° í´ë¼ì´ì–¸íŠ¸ê°€ ë§Œë“  ìš”ì²­ ìˆ˜ë¥¼ ì¶”ì í•´ì•¼ í•œë‹¤.
- Redis í˜¹ì€ Cassandraê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ ìˆ˜ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì€ ëŠë¦¬ê¸° ë•Œë¬¸ì—, Redisê°™ì€ in-memory cacheë¡œ ì²˜ë¦¬í•˜ë©´ ì¢‹ë‹¤.
- ë‘ ê°€ì§€ commandê°€ í•„ìš”í•˜ë‹¤. [Redisì˜ rate limiting ë¬¸ì„œ](https://redis.io/glossary/rate-limiting/) ìˆë‹¤. 
  - [INCR](https://redis.io/docs/latest/commands/incr/): ì €ì¥ëœ ì¹´ìš´í„°ë¥¼ 1ì”© ëŠ˜ë¦°ë‹¤.
  - [EXPIRE](https://redis.io/docs/latest/commands/expire/): ì €ì¥ëœ ì¹´ìš´í„°ì˜ íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•œë‹¤. íƒ€ì„ì•„ì›ƒì´ ë§Œë£Œë˜ë©´ ì¹´ìš´í„°ê°€ ìë™ìœ¼ë¡œ ì €ì¥ì†Œì—ì„œ ì‚­ì œëœë‹¤.


### Rate Limitì„ ë¶„ì‚°í™˜ê²½ì—ì„œ êµ¬í˜„í•  ë•Œ ìš°ë ¤ë˜ëŠ” ê²ƒ

#### Inconsistency

ì—¬ëŸ¬ê°œì˜ ì•±ì„œë²„ë“¤ì´ ë¶„ì‚°ë˜ì–´ ë‹¤ë¥¸ regionì—ì„œ ë™ì‘í•˜ê³  ìˆëŠ” ê²½ìš°, global rate limiterê°€ í•„ìš”í•˜ë‹¤.

1. Sticy Session  
ë¡œë“œë°¸ëŸ°ì„œì— sticky sessionì„ ë‘ê³ , íŠ¹ì • ìœ ì €ëŠ” íŠ¹ì • nodeë¡œë§Œ requestë¥¼ ê°€ë„ë¡ í•´ì„œ, local rate limiterë¥¼ í™œìš©í•˜ë„ë¡ í•œë‹¤. ì´ ë°©ë²•ì€ scalingí•  ìˆ˜ ì—†ê³ , í•´ë‹¹ nodeê°€ ë‹¤ìš´ë˜ì—ˆì„ ë•Œ ëŒ€ì‘ì„ í•  ìˆ˜ ì—†ë‹¤.

2. Centralized Data store  
Redisë‚˜ Cassancraì™€ ê°™ì€ ì¤‘ì•™í™”ëœ data storeë¥¼ ì‚¬ìš©í•´ì„œ rate limit ì •ë³´ë¥¼ ì €ì¥í•œë‹¤. ì§€ì—° ì‹œê°„ì´ ë¬¸ì œê°€ ë  ìˆ˜ ìˆì§€ë§Œ, ì¡°ê¸ˆ ë” ë‚˜ì€ í•´ê²°ì±…ì´ë‹¤.

#### Race Condition

concurrencyê°€ ë†’ì•„ì§€ëŠ” ê²½ìš°, race conditionì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ê° nodeì—ì„œ ë™ì‹œì— ê°™ì€ counterë¥¼ ì €ì¥í•˜ë ¤ê³  í•˜ëŠ” ê²½ìš°, counterê°€ ì¦ê°€í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
read-write operationì— lockì„ í™œìš©í•  ìˆ˜ ìˆì§€ë§Œ, ì§€ì—° ì‹œê°„ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

## Rate Limiting ì•Œê³ ë¦¬ì¦˜

### 1. Token Bucket Algorithm ğŸŒŸ í† í° ë²„í‚·

![](https://www.mimul.com/static/34b0a436c691568360a9e46dc7baca1d/ff42b/rate_tokenbucket.png)

Token Bucket Algorithmì€ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” Rate Limiting ì•Œê³ ë¦¬ì¦˜ ì¤‘ í•˜ë‚˜ë‹¤. ì´ ì•Œê³ ë¦¬ì¦˜ì€ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•œë‹¤

- ì¼ì •í•œ ì†ë„ë¡œ í† í°ì„ ë²„í‚·ì— ì¶”ê°€í•œë‹¤. ë²„í‚·ì€ ì •í•´ì§„ í¬ê¸°ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ìµœëŒ€ í¬ê¸°ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ ë²„í‚·ì—ì„œ í† í° í•˜ë‚˜ë¥¼ ì†Œëª¨í•œë‹¤. ë§Œì•½ ë²„í‚·ì— í† í°ì´ ë‚¨ì•„ìˆì§€ ì•Šë‹¤ë©´ ìš”ì²­ì´ ê±°ë¶€ssë˜ê±°ë‚˜ ì§€ì—°ëœë‹¤.
  - ì¶©ë¶„í•œ í† í°ì´ ìˆëŠ” ê²½ìš°: ë²„í‚·ì—ì„œ í† í° í•˜ë‚˜ë¥¼ êº¼ë‚¸ í›„, ìš”ì²­ì„ ì‹œìŠ¤í…œì— ì „ë‹¬í•œë‹¤.
  - ì¶©ë¶„í•œ í† í°ì´ ì—†ëŠ” ê²½ìš°: í•´ë‹¹ ìš”ì²­ì€ ë²„ë ¤ì§„ë‹¤ (dropped)
- í† í°ì´ ë²„í‚·ì— ì¶©ë¶„íˆ ìˆë‹¤ë©´ ìš”ì²­ì´ ì¦‰ì‹œ ì²˜ë¦¬ëœë‹¤.

#### êµ¬í˜„ ë°©ë²•

1. 2ê°œì˜ parameter
- ë²„í‚· í¬ê¸° : ë²„í‚·ì— ë‹´ì„ ìˆ˜ ìˆëŠ” í† í°ì˜ ìµœëŒ€ ê°œìˆ˜
- í† í° ê³µê¸‰ë¥ (refill rate) : ì´ˆë‹¹ ëª‡ ê°œì˜ í† í°ì´ ë²„í‚·ì— ê³µê¸‰ë˜ëŠ”ê°€

2. ë²„í‚·ì˜ í¬ê¸°:
ê³µê¸‰ ì œí•œ ê·œì¹™ë§ˆë‹¤ ë²„í‚· ê°œìˆ˜ê°€ ë‹¤ë¥¼ ê²ƒì´ë‹¤.
- í†µìƒì ìœ¼ë¡œëŠ” API endpointë§ˆë‹¤ ë³„ë„ì˜ ë²„í‚·ì„ ë‘”ë‹¤. ì‚¬ìš©ìë§ˆë‹¤ ì—…ë¡œë“œ ì œí•œ ì •ì±…ì´ ìˆë‹¤ë©´, ì‚¬ìš©ìë§ˆë‹¤ nê°œì˜ ë²„í‚·ì„ ë‘˜ ê²ƒì´ë‹¤.
- IP ì£¼ì†Œë³„ë¡œ ì²˜ë¦¬ìœ¨ ì œí•œì„ ì ìš©í•´ì•¼ í•œë‹¤ë©´ IP ì£¼ì†Œë§ˆë‹¤ ë²„í‚·ì„ í•˜ë‚˜ì”© í• ë‹¹í•´ì•¼ í•œë‹¤.
- ì‹œìŠ¤í…œ ì²˜ë¦¬ìœ¨ì„ ì´ˆë‹¹ 10,000ê°œë¡œ ì œí•œí•˜ê³  ì‹¶ë‹¤ë©´, ëª¨ë“  ìš”ì²­ì´ í•˜ë‚˜ì˜ ë²„í‚·ì„ ê³µìœ í•˜ë„ë¡ í•´ì•¼ í•  ê²ƒì´ë‹¤.

#### ìœ ì˜í•  ì 

 - ë¶„ì‚°ì‹œìŠ¤í…œì—ì„œ, ë§Œì•½ í•˜ë‚˜ì˜ í† í°ë§Œ ë‚¨ì•„ìˆëŠ” ìƒí™©ì—ì„œ ë‘ ì„œë²„ì˜ Redis ì‘ì—…ì´ ì„œë¡œ ê²¹ì¹˜ë©´ ë‘ ìš”ì²­ ëª¨ë‘ í—ˆìš©ë  ê²ƒì´ë‹¤.
 - Redis lockì„ íšë“í•œë‹¤ë©´ ì›ìì„±ì„ ì§€í‚¬ ìˆ˜ ìˆê² ì§€ë§Œ, ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ì†ë„ë¥¼ ëŠ¦ì¶”ëŠ” ëŒ€ê°€ë¥¼ ì¹˜ë¥´ê²Œ ëœë‹¤.
 - ì´ë¥¼ ë°©ì§€í•˜ë ¤ë©´, Lua scriptingì„ ì´ìš©í•´ Redisì˜ ì‘ì—…ì„ ì›ìì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

#### ì¥ë‹¨ì 

ì¥ì :
- êµ¬í˜„ì´ ì‰½ë‹¤.
- ë©”ëª¨ë¦¬ ì‚¬ìš© ì¸¡ë©´ì—ì„œ íš¨ìœ¨ì ì´ë‹¤.
- ì§§ì€ ì‹œê°„ burst íŠ¸ë˜í”½(ì§§ì€ ì‹œê°„ ë‚´ì— ì§‘ì¤‘ëœ íŠ¸ë˜í”½)ì„ í—ˆìš©í•˜ë©´ì„œë„ ì „ì²´ì ì¸ ìš”ì²­ ì†ë„ë¥¼ ì œí•œí•˜ëŠ” ë° ìœ ìš©í•˜ë‹¤. ë²„í‚·ì— ë‚¨ì€ í† í°ì´ ìˆê¸°ë§Œ í•˜ë©´ ìš”ì²­ì€ ì‹œìŠ¤í…œì— ì „ë‹¬ë  ê²ƒì´ë‹¤.

ë‹¨ì : 
- ë²„í‚· í¬ê¸°ì™€ í† í° ê³µê¸‰ë¥ ì´ë¼ëŠ” ë‘ ê°œì˜ ì¸ìë¥¼ ê°€ì§€ê³  ìˆëŠ”ë°, ì´ ê°’ì„ íŠœë‹í•˜ëŠ” ê²ƒì´ ê¹Œë‹¤ë¡œìš´ ì¼ì´ë‹¤.

##### êµ¬í˜„ ì½”ë“œ ì˜ˆì‹œ

```java
import java.time.Duration;
import java.time.Instant;
import java.util.concurrent.atomic.AtomicLong;

public class TokenBucketRateLimiter {
    private final long capacity;
    private final AtomicLong tokens;
    private final Duration refillPeriod;
    private volatile Instant lastRefillTime;

    public TokenBucketRateLimiter(long capacity, Duration refillPeriod) {
        this.capacity = capacity; // maximum ì²˜ë¦¬ëŸ‰
        this.tokens = new AtomicLong(capacity); // ì²˜ë¦¬ ê°€ëŠ¥í•œ í† í°ì˜ ê°¯ìˆ˜
        this.refillPeriod = refillPeriod; // í† í°ì´ ë¦¬í•„ë˜ëŠ” ê¸°ê°„
        this.lastRefillTime = Instant.now(); // ë§ˆì§€ë§‰ í† í°ë¦¬í•„ ì‹œê°
    }

    public synchronized boolean isAllowed() {
        refillTokens();

        long currentTokens = tokens.get();
        if (currentTokens > 0) {
            tokens.decrementAndGet();
            return true; // Request is allowed
        }

        return false; // Request is not allowed
    }

    /**
     * Refills tokens in the token bucket based on the refill period.
     */
    private synchronized void refillTokens() {
        Instant now = Instant.now();
        long timeElapsed = Duration.between(lastRefillTime, now).toMillis();
        long tokensToAdd = timeElapsed / refillPeriod.toMillis();

        if (tokensToAdd > 0) {
            lastRefillTime = now;
            tokens.getAndUpdate(currentTokens -> Math.min(capacity, currentTokens + tokensToAdd));
        }
    }
}
```

##### [Bucket4j ë¼ì´ë¸ŒëŸ¬ë¦¬](https://github.com/bucket4j/bucket4j)

> Java rate-limiting library based on token-bucket algorithm

```java
import io.github.bucket4j.Bucket;

...
// bucket with capacity 20 tokens
// with refilling speed 1 token per each 6 second
private static Bucket bucket = Bucket.builder()
      .addLimit(limit -> limit.capacity(20).refillGreedy(10, Duration.ofMinutes(1)))
      .build();

private void doSomethingProtected() {
   if (bucket.tryConsume(1)) {
      doSomething();    
   } else {
      throw new SomeRateLimitingException();
   }
}
```

##### [Guava](https://github.com/google/guava)

> [Rate Limter](https://guava.dev/releases/snapshot-jre/api/docs/com/google/common/util/concurrent/RateLimiter.html)ê°€ ìˆëŠ” Google Core Libraries for Java

```java
 final RateLimiter rateLimiter = RateLimiter.create(2.0); // rate is "2 permits per second"
 void submitTasks(List<Runnable> tasks, Executor executor) {
   for (Runnable task : tasks) {
     rateLimiter.acquire(); // may wait
     executor.execute(task);
   }
 }
 
```

### 2. Leaky Bucket Algorithm ğŸŒŸ ëˆ„ì¶œ ë²„í‚·

![](https://www.mimul.com/static/53e202f8b985d2acb8fd7081248688ce/b5245/rate_leakybucket.png)

Leaky Bucket Algorithmì€ í† í° ë²„í‚· ì•Œê³ ë¦¬ì¦˜ê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ, íŠ¸ë˜í”½ íë¦„ì„ ë”ìš± ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆë‹¤.

- ë²„í‚·ì— ë¬¼(ë°ì´í„° íŒ¨í‚·)ì´ ë“¤ì–´ì˜¤ë©´, ì¼ì •í•œ ì†ë„ë¡œ ë¬¼ì´ ìƒˆì–´ ë‚˜ì˜¨ë‹¤.
- ë§Œì•½ ë²„í‚·ì— ë¬¼ì´ ë„˜ì¹˜ë©´ ì´ˆê³¼ëœ ë¬¼(ì¶”ê°€ ìš”ì²­)ì€ ë²„ë ¤ì§„ë‹¤.

ì´ ì•Œê³ ë¦¬ì¦˜ì€ íŠ¸ë˜í”½ì´ ê°‘ìê¸° ì¦ê°€í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³ , ì¼ì •í•œ ì†ë„ë¡œ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ë° íš¨ê³¼ì ì´ë‹¤.

##### êµ¬í˜„ ì½”ë“œ ì˜ˆì‹œ

```java
import java.time.Duration;
import java.util.concurrent.atomic.AtomicLong;

public class LeakyBucketRateLimiter {
    private final long capacity;
    private final long ratePerSecond;
    private final AtomicLong lastRequestTime;
    private final AtomicLong currentBucketSize;

    public LeakyBucketRateLimiter(long capacity, long ratePerSecond) {
        this.capacity = capacity;
        this.ratePerSecond = ratePerSecond;
        this.lastRequestTime = new AtomicLong(System.currentTimeMillis());
        this.currentBucketSize = new AtomicLong(0);
    }

    public synchronized boolean isAllowed() {
        long currentTime = System.currentTimeMillis();
        long elapsedTime = currentTime - lastRequestTime.getAndSet(currentTime);

        // Calculate the amount of tokens leaked since the last request
        long leakedTokens = elapsedTime * ratePerSecond / 1000;
        currentBucketSize.updateAndGet(bucketSize ->
                Math.max(0, Math.min(bucketSize + leakedTokens, capacity)));

        // Check if a request can be processed by consuming a token from the bucket
        if (currentBucketSize.get() > 0) {
            currentBucketSize.decrementAndGet();
            return true; // Request is allowed
        }

        return false; // Request is not allowed
    }
}
```

### 3. Fixed Window Counter ğŸŒŸ ê³ ì • ìœˆë„ìš° ì¹´ìš´í„°

![](https://www.mimul.com/static/fc309200b26de4d6322f48fd3719518a/0a47e/rate_fixed_window_counter.png)

Fixed Window CounterëŠ” ê°„ë‹¨í•˜ë©´ì„œë„ íš¨ê³¼ì ì¸ ë°©ë²•ì´ë‹¤.

- ì¼ì •í•œ ì‹œê°„ ì°½(ì˜ˆ: 1ë¶„, 1ì‹œê°„ ë“±)ì„ ì •ì˜í•˜ê³ , ê·¸ ì‹œê°„ ë™ì•ˆì˜ ìš”ì²­ ìˆ˜ë¥¼ ì¹´ìš´íŠ¸í•œë‹¤.
- ìš”ì²­ ìˆ˜ê°€ ì„¤ì •í•œ í•œë„ë¥¼ ì´ˆê³¼í•˜ë©´, í•´ë‹¹ ì‹œê°„ ì°½ì´ ëë‚  ë•Œê¹Œì§€ ì¶”ê°€ ìš”ì²­ì´ ê±°ë¶€ëœë‹¤.

ì´ ë°©ë²•ì€ êµ¬í˜„ì´ ê°„ë‹¨í•˜ì§€ë§Œ, ì‹œê°„ ì°½ ê²½ê³„ì—ì„œ íŠ¸ë˜í”½ì´ ì§‘ì¤‘ë  ë•Œ "thundering herd" ë¬¸ì œ(í•œ ì‹œê°„ ì°½ì˜ ëì—ì„œ ì‹œì‘ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì‹œì ì— ë§ì€ ìš”ì²­ì´ ëª°ë¦¬ëŠ” í˜„ìƒ)ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

##### êµ¬í˜„ ì½”ë“œ ì˜ˆì‹œ

```java
import java.util.HashMap;
import java.util.Map;

public class RateLimiter {
    private final int maxRequestPerWindow;
    private final long windowSizeInMillis;
    private final Map<String, Window> store = new HashMap<>();

    public RateLimiter(int maxRequestPerWindow, long windowSizeInMillis) {
        this.maxRequestPerWindow = maxRequestPerWindow;
        this.windowSizeInMillis = windowSizeInMillis;
    }

    public synchronized boolean isAllowed(String clientId) {
        long currentTimeMillis = System.currentTimeMillis();
        Window window = store.get(clientId);

        // If the window doesn't exist or has expired, create a new window
        if (window == null || window.getStartTime() < currentTimeMillis - windowSizeInMillis) {
            window = new Window(currentTimeMillis, 0);
        }

        // Check if the number of requests in the window exceeds the maximum allowed
        if (window.getRequestCount() >= maxRequestPerWindow) {
            return false; // Request is not allowed
        }

        // Increment the request count and update the window in the store
        window.setRequestCount(window.getRequestCount() + 1);
        store.put(clientId, window);
        return true; // Request is allowed
    }

    private static class Window {
        private final long startTime;
        private int requestCount;

        public Window(long startTime, int requestCount) {
            this.startTime = startTime;
            this.requestCount = requestCount;
        }

        public long getStartTime() {
            return startTime;
        }

        public int getRequestCount() {
            return requestCount;
        }

        public void setRequestCount(int requestCount) {
            this.requestCount = requestCount;
        }
    }
}
```

### 4. Sliding Window Log ğŸŒŸ ì´ë™ ìœˆë„ìš° ë¡œê·¸

![](https://www.mimul.com/static/75653188f6e1eb96a9e9bf861f538f6e/90712/rate_sliding-window-log.png)

Sliding Window LogëŠ” Fixed Window Counterì˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ê³ ì•ˆëœ ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.

- ìš”ì²­ì´ ë°œìƒí•  ë•Œë§ˆë‹¤ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë¡í•˜ê³ , ì´ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¼ì •í•œ ì‹œê°„ ì°½ ë‚´ì˜ ìš”ì²­ ìˆ˜ë¥¼ ê³„ì‚°í•œë‹¤.
- ì‹œê°„ ì°½ ë‚´ì˜ ìš”ì²­ ìˆ˜ê°€ í•œë„ë¥¼ ì´ˆê³¼í•˜ë©´ ìš”ì²­ì´ ê±°ë¶€ëœë‹¤.

ì´ ì•Œê³ ë¦¬ì¦˜ì€ ì‹œê°„ ì°½ ê²½ê³„ì—ì„œ ë°œìƒí•˜ëŠ” íŠ¸ë˜í”½ ì§‘ì¤‘ ë¬¸ì œë¥¼ ì¤„ì—¬ì¤€ë‹¤. í•˜ì§€ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì €ì¥í•´ì•¼ í•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í•  ìˆ˜ ìˆë‹¤.

### 5. Sliding Window Counter ğŸŒŸ ì´ë™ ìœˆë„ìš° ì¹´ìš´í„°

![](https://www.mimul.com/static/1823b61524cd87ef9438cdca3d395a92/6b1e2/rate_sliding-window.png)

Sliding Window CounterëŠ” Sliding Window Logì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ë°©ë²•ì´ë‹¤.

- ì‹œê°„ì„ ì‘ì€ êµ¬ê°„(ì˜ˆ: 1ì´ˆ)ìœ¼ë¡œ ë‚˜ëˆ„ê³ , ê° êµ¬ê°„ì˜ ìš”ì²­ ìˆ˜ë¥¼ ì¹´ìš´íŠ¸í•œë‹¤.
- ì „ì²´ ì‹œê°„ ì°½ ë™ì•ˆì˜ ìš”ì²­ ìˆ˜ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ í˜„ì¬ êµ¬ê°„ê³¼ ì´ì „ êµ¬ê°„ì˜ ì¹´ìš´íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ ìˆ˜ë¥¼ ê³„ì‚°í•œë‹¤.

ì´ ë°©ì‹ì€ ë¡œê·¸ë¥¼ ì €ì¥í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì¤„ì–´ë“¤ì§€ë§Œ, ì—¬ì „íˆ ì‹œê°„ ì°½ ê²½ê³„ì—ì„œ ì•½ê°„ì˜ ë¶€ì •í™•ì„±ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

##### êµ¬í˜„ ì½”ë“œ ì˜ˆì‹œ

```java
import java.util.Deque;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentLinkedDeque;

public class SlidingWindowRateLimiter {
    private final int maxRequests;
    private final long windowSizeInMillis;
    private final ConcurrentHashMap<String, Deque<Long>> timestamps = new ConcurrentHashMap<>();

    public SlidingWindowRateLimiter(int maxRequests, long windowSizeInMillis) {
        this.maxRequests = maxRequests;
        this.windowSizeInMillis = windowSizeInMillis;
    }

    public boolean isAllowed(String clientId) {
        // Get the timestamp deque for the client, creating a new one if it doesn't exist
        Deque<Long> clientTimestamps = timestamps.computeIfAbsent(clientId, k -> new ConcurrentLinkedDeque<>());

        // Get the current timestamp in milliseconds
        long currentTimeMillis = System.currentTimeMillis();

        // Remove timestamps older than the sliding window
        while (!clientTimestamps.isEmpty() && currentTimeMillis - clientTimestamps.peekFirst() > windowSizeInMillis) {
            clientTimestamps.pollFirst();
        }

        // Check if the number of requests in the sliding window exceeds the maximum allowed
        if (clientTimestamps.size() < maxRequests) {
            clientTimestamps.addLast(currentTimeMillis);
            return true; // Request is allowed
        }

        return false; // Request is not allowed
    }
}

```

### 6. Exponential Backoff
Exponential BackoffëŠ” ì£¼ë¡œ ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì „ëµìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ë§Œ, Rate Limitingê³¼ í•¨ê»˜ ì ìš©í•  ìˆ˜ ìˆë‹¤.

- í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ, ì‹¤íŒ¨í•œ ê²½ìš° ì¬ì‹œë„ ê°„ê²©ì„ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€ì‹œí‚¨ë‹¤.
- ì´ ë°©ë²•ì€ ì„œë²„ ê³¼ë¶€í•˜ë¥¼ ë°©ì§€í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ ì—°ì†ì ìœ¼ë¡œ ê±°ë¶€ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ë° ìœ ìš©í•˜ë‹¤.

ì´ ë°©ë²•ì€ ì£¼ë¡œ API Rate Limiting ìƒí™©ì—ì„œ ìš”ì²­ì„ ê´€ë¦¬í•˜ê³ , ì‹œìŠ¤í…œì— ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•œ ë³´ì¡° ì „ëµìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.

> Token Bucketì´ë‚˜ Leaky Bucket ê°™ì€ ì•Œê³ ë¦¬ì¦˜ì€ ë²„ìŠ¤íŠ¸ íŠ¸ë˜í”½ì„ ê´€ë¦¬í•˜ëŠ” ë° íš¨ê³¼ì ì´ê³ , Fixed Window Counterë‚˜ Sliding Window CounterëŠ” êµ¬í˜„ì´ ë‹¨ìˆœí•˜ë©´ì„œë„ ì‹¤ìš©ì ì´ë‹¤. Exponential BackoffëŠ” ì¬ì‹œë„ ë¡œì§ì— ìœ ìš©í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì¶”ê°€ì ì¸ ì „ëµì´ë‹¤.


###### reference


> [ì„œë¹„ìŠ¤ ê°€ìš©ì„± í™•ë³´ì— í•„ìš”í•œ Rate Limiting Algorithmì— ëŒ€í•´](https://www.mimul.com/blog/about-rate-limit-algorithm/)  
> [How to Design a Rate Limiter API | Learn System Design](https://www.geeksforgeeks.org/how-to-design-a-rate-limiter-api-learn-system-design/?ref=oin_asr2)  
> ê°€ìƒ ë©´ì ‘ ì‚¬ë¡€ë¡œ ë°°ìš°ëŠ” ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ ì„¤ê³„ ê¸°ì´ˆ  
> (Slow Down! Rate Limiting Deep Dive)[https://www.codereliant.io/rate-limiting-deep-dive/]  
> ()[https://hogwart-scholars.tistory.com/entry/Spring-Boot-%EC%9E%90%EB%B0%94-%EC%8A%A4%ED%94%84%EB%A7%81%EC%97%90%EC%84%9C-%EC%B2%98%EB%A6%AC%EC%9C%A8-%EC%A0%9C%ED%95%9C-%EA%B8%B0%EB%8A%A5%EC%9D%84-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-4%EA%B0%80%EC%A7%80-%EB%B0%A9%EB%B2%95]